{% macro export_features() %}
        if ! is_acceptable_size() then {
            reject;
        }
        else if ((65000, 202) ~ bgp_community || (65000, 2, peerasn) ~ bgp_large_community || (65000, 2, 0) ~ bgp_large_community) then {
            bgp_path.prepend(65000);
        }
        else if ((65000, 203) ~ bgp_community || (65000, 3, peerasn) ~ bgp_large_community || (65000, 3, 0) ~ bgp_large_community) then {
            bgp_path.prepend(65000);
            bgp_path.prepend(65000);
        }

        if (graceful_shutdown = 1) then {
            # enable the graceful shutdown community
            bgp_community.add((65535, 0));
        }

        if (   (65000, 204) ~ bgp_community
            || (65000, 303) ~ bgp_community
            || (65000, 4, peerasn) ~ bgp_large_community
            || (65000, 4, 0) ~ bgp_large_community
            || (65000, 303, 0) ~ bgp_large_community
           ) then {
            reject;
        }
{% endmacro %}

function allow_graceful_shutdown() {
    if (65535, 0) ~ bgp_community then {
        bgp_local_pref = 0;
    }
}

function ebgp_peering_export(int peerasn; int graceful_shutdown) {
    if ( is_local_supernet()
        || is_local_beacon()
        || (65000, 2) ~ bgp_community
        || (65000, 0, 2) ~ bgp_large_community
        ) then {

        bgp_path.delete([64512..65534]);

        {{ export_features() }}

        # do not advertise prefixes to some ASN via routeservers
        # AMS-IX, NL-IX, Asteroid, SPEED-IX, Inter-IX, Frys-IX, DE-CIX, FranceIX, SwissIX, Locix NL, ERA-IX
        if (peerasn ~ [6777, 34307, 41693, 41441, 56584, 56393, 6695, 51706, 42476, 209643, 206221]) then {
             bgp_community.add((0,6939));     # Hurricane Electric
             bgp_community.add((0,16276));    # OVH
             bgp_community.add((0,24940));    # Hetzner
             bgp_community.add((0,47160));    # Moji
             bgp_community.add((0,12876));    # Scaleway
        }
        accept;
    }
    reject;
}

function full_table_export(int peerasn; int graceful_shutdown) {
    if ( is_local_supernet() ) then accept;
    else if ( is_local_more_specific() ) then {
        reject;
    }
    else if ( is_bogon() ) then reject;
    else if ( bgp_path.last = 65000 ) then reject;
    else {
        {{ export_features () }}
        accept;
    }
}

/*
    This filter is used for peers for which
    we cannot do strict IRR filtering
*/
filter ebgp_unfiltered_peering_import
prefix set acceptable_sizes;
{
    # https://tools.ietf.org/html/draft-ietf-grow-bgp-gshut-06
    allow_graceful_shutdown();

    # Scrub communities from peering partners
    bgp_community.delete((65535, 666));
    bgp_community.delete([(65000, *)]);
    bgp_large_community.delete([(65000, *, *)]);

    if is_bogon_aspath() then {
        print "Reject: bogon AS_PATH: ", net, " ", bgp_path, " protocol: ", proto;
        bgp_large_community.add((65000, rejected_route, r_bogon_aspath));
        reject;
    }

    if ( is_local_more_specific() ) then {
        bgp_large_community.add((65000, rejected_route, r_local_morespecific));
        reject;
    }
    if ( is_bogon() ) then {
        bgp_large_community.add((65000, rejected_route, r_bogon_prefix));
        reject;
    }

{% if rpki.validation %}
    reject_rpki_invalid();
{% endif %}

    if is_acceptable_size() then {
        bgp_med = 0;
        bgp_community.add((65000,1));
        bgp_large_community.add((65000, 0, 1));
        accept;
    }
    bgp_large_community.add((65000, rejected_route, r_unacceptable_pfxlen));
    reject;
}
